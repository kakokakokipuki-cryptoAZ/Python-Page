<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Pico Morse Controller</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #1a1a1a; color: #00ff00; padding: 20px; }
        #display { font-size: 4rem; margin: 20px auto; min-height: 1.2em; background: #000; border-radius: 10px; padding: 20px; }
        .controls { display: flex; justify-content: center; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        button { padding: 10px 20px; font-size: 1rem; cursor: pointer; border: none; border-radius: 5px; color: white; }
        #connect { background: #008cba; }
        #reset { background: #ff4444; }
        .mode-btn { background: #444; }
    </style>
</head>
<body>
    <h1>Morse Decoder Web</h1>
    <div id="display">---</div>

    <div class="controls">
        <button id="connect">PICOと接続</button>
        <button id="reset">PICOをリセット</button>
        <!-- ここにモード切替ボタンを追加！ -->
        <button id="set-eng" class="mode-btn">欧文(ABC)</button>
        <button id="set-kana" class="mode-btn">和文(カナ)</button>
    </div>
    <div id="status" style="margin-top:20px; color:#888;">切断中</div>

    <script>
        let port;
        const display = document.getElementById('display');
        const status = document.getElementById('status');

        // 接続処理
        document.getElementById('connect').addEventListener('click', async () => {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });
                status.innerText = "接続済み";
                
                const decoder = new TextDecoderStream();
                port.readable.pipeTo(decoder.writable);
                const reader = decoder.readable.getReader();
                display.innerText = "";
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    if (value) {
                        const char = value.trim();
                        if (char === "RESET_ACK") display.innerText = "";
                        else if (char) display.innerText += char;
                    }
                }
            } catch (err) { status.innerText = "エラー: " + err; }
        });

        // 1. リセット送信
        document.getElementById('reset').addEventListener('click', () => sendToPico("R"));

        // 2. モード送信
        document.getElementById('set-eng').addEventListener('click', () => {
            sendToPico("E");
            status.innerText = "モード: 欧文(ABC)";
        });

        document.getElementById('set-kana').addEventListener('click', () => {
            sendToPico("K");
            status.innerText = "モード: 和文(カナ)";
        });

        // 送信用共通関数
        async function sendToPico(msg) {
            if (port && port.writable) {
                const writer = port.writable.getWriter();
                await writer.write(new TextEncoder().encode(msg + "\n"));
                writer.releaseLock();
            }
        }
    </script>
</body>
</html>
