<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pico Morse Web Controller</title>
    <style>
        body { font-family: 'Courier New', Courier, monospace; text-align: center; background: #1a1a1a; color: #00ff00; padding: 20px; }
        h1 { color: #fff; text-shadow: 0 0 10px #00ff00; }
        #display { font-size: 5rem; margin: 40px auto; min-height: 1.5em; border: 2px solid #333; background: #000; padding: 20px; border-radius: 10px; word-wrap: break-word; }
        .controls { display: flex; justify-content: center; gap: 20px; margin-top: 30px; }
        button { padding: 15px 30px; font-size: 1.1rem; font-weight: bold; cursor: pointer; border: none; border-radius: 50px; transition: 0.3s; }
        #connect { background: #008cba; color: white; box-shadow: 0 4px #005f7a; }
        #connect:active { transform: translateY(4px); box-shadow: none; }
        #reset { background: #ff4444; color: white; box-shadow: 0 4px #cc0000; display: none; }
        #reset:active { transform: translateY(4px); box-shadow: none; }
        .status { margin-top: 10px; font-size: 0.9rem; color: #888; }
    </style>
</head>
<body>
    <h1>Pico Morse Receiver</h1>
    
    <div id="display">---</div>

    <div class="controls">
        <button id="connect">PICOと接続</button>
        <button id="reset">PICOをリセット</button>
    </div>
    <div id="status" class="status">切断中</div>

    <script>
        let port;
        let reader;
        const connectBtn = document.getElementById('connect');
        const resetBtn = document.getElementById('reset');
        const display = document.getElementById('display');
        const status = document.getElementById('status');

        // 接続処理
        connectBtn.addEventListener('click', async () => {
            try {
                // 1. ポート選択
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });
                
                status.innerText = "接続済み (Board in FS mode)";
                connectBtn.style.display = "none";
                resetBtn.style.display = "inline-block";
                display.innerText = "";

                // 2. 受信ループ
                const decoder = new TextDecoderStream();
                port.readable.pipeTo(decoder.writable);
                reader = decoder.readable.getReader();

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    if (value) {
                        const char = value.trim();
                        if (char === "RESET_ACK") {
                            display.innerText = ""; // Picoからリセット完了が届いたら画面を消す
                        } else if (char) {
                            display.innerText += char;
                        }
                    }
                }
            } catch (err) {
                console.error(err);
                status.innerText = "エラー: " + err.message;
            }
        });

        // 3. リセット命令をPicoに送る
        resetBtn.addEventListener('click', async () => {
            if (port && port.writable) {
                const encoder = new TextEncoder();
                const writer = port.writable.getWriter();
                // "R" という文字をPicoに送信
                await writer.write(encoder.encode("R\n")); 
                writer.releaseLock();
                display.innerText = ""; 
            }
        });
    </script>
</body>
</html>
